<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Keysys Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="login-overlay" id="loginOverlay">
        <div class="login-card">
            <h2>Admin Login</h2>
            <form id="loginForm">
                <input type="text" id="username" placeholder="Username (admin)" value="admin">
                <input type="password" id="password" placeholder="Password">
                <button type="submit">Enter Dashboard</button>
            </form>
        </div>
    </div>

    <div class="dashboard" id="dashboard" style="display: none;">
        <header>
            <h1>Keysys Pro</h1>
            <nav>
                <button class="tab-btn active" data-tab="generator">Generator</button>
                <button class="tab-btn" data-tab="stats">Statistics</button>
                <button class="tab-btn" data-tab="management">Key Management</button>
            </nav>
        </header>

        <main>
            <!-- Generator Tab -->
            <section id="generator" class="tab-content active">
                <h2>Generate New Key</h2>
                <form id="keyForm">
                    <label for="userId">Roblox User ID:</label>
                    <input type="number" id="userId" required>
                    
                    <label for="discordTag">Discord Tag:</label>
                    <input type="text" id="discordTag" placeholder="user#1234" required>
                    
                    <label for="expiresDays">Expiration (Days):</label>
                    <input type="number" id="expiresDays" value="7" min="1" max="365">
                    
                    <button type="submit">Generate Key</button>
                </form>
                <div id="genResult" class="toast"></div>
            </section>

            <!-- Stats Tab -->
            <section id="stats" class="tab-content">
                <h2>System Statistics</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Total Keys</h3>
                        <p id="totalKeys" class="stat-value">0</p>
                        <div class="stat-bar full"></div>
                    </div>
                    <div class="stat-card">
                        <h3>Active Keys</h3>
                        <p id="activeKeys" class="stat-value">0</p>
                        <div class="stat-bar" id="activeBar"></div>
                    </div>
                    <div class="stat-card">
                        <h3>Used Keys</h3>
                        <p id="usedKeys" class="stat-value">0</p>
                        <div class="stat-bar" id="usedBar"></div>
                    </div>
                    <div class="stat-card">
                        <h3>Expired Keys</h3>
                        <p id="expiredKeys" class="stat-value">0</p>
                        <div class="stat-bar" id="expiredBar"></div>
                    </div>
                </div>
                <button id="exportCSV">Export Stats as CSV</button>
                <div id="statsResult" class="toast"></div>
            </section>

            <!-- Management Tab -->
            <section id="management" class="tab-content">
                <h2>Manage Keys</h2>
                <div id="keysList"></div>
                <div id="mgmtResult" class="toast"></div>
            </section>
        </main>
    </div>

    <script>
        const AUTH = 'Basic ' + btoa('admin:admin123');
        const API_BASE = '/api';

        // Login
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = document.getElementById('username').value;
            const pass = document.getElementById('password').value;
            try {
                const res = await fetch(`${API_BASE}/stats`, { headers: { Authorization: 'Basic ' + btoa(user + ':' + pass) } });
                if (res.ok) {
                    document.getElementById('loginOverlay').style.display = 'none';
                    document.getElementById('dashboard').style.display = 'block';
                    loadStats();
                    loadKeys();
                } else {
                    alert('Invalid login');
                }
            } catch (err) {
                alert('Login error');
            }
        });

        // Tab Switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById(btn.dataset.tab).classList.add('active');
            });
        });

        // Generator
        document.getElementById('keyForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = {
                userId: document.getElementById('userId').value,
                discordTag: document.getElementById('discordTag').value,
                expiresDays: document.getElementById('expiresDays').value
            };
            const res = await fetch(`${API_BASE}/generate-key`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', Authorization: AUTH },
                body: JSON.stringify(formData)
            });
            const data = await res.json();
            const result = document.getElementById('genResult');
            if (data.key) {
                result.innerHTML = `<p>Key: <strong>${data.key}</strong> (Expires: ${data.expires})</p>`;
                result.className = 'toast success';
                loadStats();
                loadKeys();
            } else {
                result.innerHTML = `<p>Error: ${data.error}</p>`;
                result.className = 'toast error';
            }
            setTimeout(() => result.classList.add('show'), 10);
        });

        // Stats Loader
        async function loadStats() {
            const res = await fetch(`${API_BASE}/stats`, { headers: { Authorization: AUTH } });
            const stats = await res.json();
            document.getElementById('totalKeys').textContent = stats.total;
            document.getElementById('activeKeys').textContent = stats.active;
            document.getElementById('usedKeys').textContent = stats.used;
            document.getElementById('expiredKeys').textContent = stats.expired;

            // Update bars (percentage of total)
            const updateBar = (id, val) => {
                const bar = document.getElementById(id);
                const perc = stats.total > 0 ? (val / stats.total * 100) : 0;
                bar.style.width = perc + '%';
                bar.dataset.value = val;
            };
            updateBar('activeBar', stats.active);
            updateBar('usedBar', stats.used);
            updateBar('expiredBar', stats.expired);
        }

        // Export CSV
        document.getElementById('exportCSV').addEventListener('click', async () => {
            const res = await fetch(`${API_BASE}/stats`, { headers: { Authorization: AUTH } });
            const stats = await res.json();
            const csv = `Metric,Value\nTotal Keys,${stats.total}\nActive,${stats.active}\nUsed,${stats.used}\nExpired,${stats.expired}`;
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'keys-stats.csv'; a.click();
        });

        // Keys Loader
        async function loadKeys() {
            const res = await fetch(`${API_BASE}/keys`, { headers: { Authorization: AUTH } });
            const keys = await res.json();
            const list = document.getElementById('keysList');
            list.innerHTML = keys.map(key => `
                <div class="key-card ${key.used ? 'used' : key.expires < new Date().toISOString().slice(0,19).replace('T',' ') ? 'expired' : 'active'}">
                    <div class="key-info">
                        <strong>${key.key}</strong><br>
                        UserID: ${key.userId} | Discord: ${key.discordTag}<br>
                        Expires: ${key.expires} | Status: ${key.used ? 'Used' : (key.expires < new Date().toISOString().slice(0,19).replace('T',' ') ? 'Expired' : 'Active')}
                    </div>
                    <button onclick="revokeKey(${key.id})" class="revoke-btn">Revoke</button>
                </div>
            `).join('');
        }

        // Revoke Key
        window.revokeKey = async (id) => {
            const res = await fetch(`${API_BASE}/revoke-key/${id}`, {
                method: 'DELETE',
                headers: { Authorization: AUTH }
            });
            const data = await res.json();
            const result = document.getElementById('mgmtResult');
            result.innerHTML = `<p>${data.message}</p>`;
            result.className = 'toast success';
            setTimeout(() => result.classList.add('show'), 10);
            loadKeys();
            loadStats();
        };
    </script>
</body>
</html>
